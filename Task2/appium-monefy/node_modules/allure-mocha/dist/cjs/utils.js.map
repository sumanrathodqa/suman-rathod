{"version":3,"file":"utils.js","names":["_nodePath","require","_nodeUrl","_allureJsCommons","_sdk","_reporter","filename","fileURLToPath","pathToFileURL","__filename","toString","allureMochaDataKey","Symbol","getAllureData","item","data","meta","extractMetadataFromString","title","defaultData","isIncludedInTestRun","fullName","createAllureFullName","labels","links","displayName","cleanTitle","test","titlePath","join","file","concat","getPosixPath","getRelativePath","createTestPlanSelectorIndex","testplan","createTestPlanIndex","e","selector","createTestPlanIdIndex","_e$id","id","keySelector","Set","tests","map","filter","v","createTestPlanIndices","parseTestPlan","fullNameIndex","idIndex","exports","getAllureFullName","getAllureMetaLabels","getAllureMetaLinks","getAllureId","values","l","name","LabelName","ALLURE_ID","value","length","getAllureDisplayName","getTestScope","scope","setTestScope","getSuitesOfMochaTest","slice","resolveParallelModeSetupFile","dirname","extname","getTestCaseId","testFilePath","suiteTitles","md5","JSON","stringify","applyTestPlan","ids","selectors","rootSuite","suiteQueue","s","shift","allureData","allureId","has","pending","push","suites","hookTypeRegexp","getHookType","hook","match","exec"],"sources":["../../src/utils.ts"],"sourcesContent":["import type * as Mocha from \"mocha\";\nimport { dirname, extname, join } from \"node:path\";\nimport { fileURLToPath } from \"node:url\";\nimport { LabelName } from \"allure-js-commons\";\nimport type { TestPlanV1, TestPlanV1Test } from \"allure-js-commons/sdk\";\nimport { extractMetadataFromString } from \"allure-js-commons/sdk\";\nimport { getPosixPath, getRelativePath, md5, parseTestPlan } from \"allure-js-commons/sdk/reporter\";\nimport type { AllureMochaTestData, HookCategory, HookScope, HookType, TestPlanIndices } from \"./types.js\";\n\nconst filename = fileURLToPath(import.meta.url);\n\nconst allureMochaDataKey = Symbol(\"Used to access Allure extra data in Mocha objects\");\n\nconst getAllureData = (item: Mocha.Test): AllureMochaTestData => {\n  const data = (item as any)[allureMochaDataKey];\n\n  if (!data) {\n    const meta = extractMetadataFromString(item.title);\n    const defaultData: AllureMochaTestData = {\n      isIncludedInTestRun: true,\n      fullName: createAllureFullName(item),\n      labels: meta.labels,\n      links: meta.links,\n      displayName: meta.cleanTitle,\n    };\n\n    (item as any)[allureMochaDataKey] = defaultData;\n\n    return defaultData;\n  }\n\n  return data;\n};\n\nconst createAllureFullName = (test: Mocha.Test) => {\n  const titlePath = test.titlePath().join(\" > \");\n  return test.file ? `${getPosixPath(getRelativePath(test.file))}: ${titlePath}` : titlePath;\n};\n\nconst createTestPlanSelectorIndex = (testplan: TestPlanV1) => createTestPlanIndex((e) => e.selector, testplan);\n\nconst createTestPlanIdIndex = (testplan: TestPlanV1) => createTestPlanIndex((e) => e.id?.toString(), testplan);\n\nconst createTestPlanIndex = <T>(keySelector: (entry: TestPlanV1Test) => T | undefined, testplan: TestPlanV1): Set<T> =>\n  new Set(testplan.tests.map((e) => keySelector(e)).filter((v) => v)) as Set<T>;\n\nexport const createTestPlanIndices = (): TestPlanIndices | undefined => {\n  const testplan = parseTestPlan();\n  if (testplan) {\n    return {\n      fullNameIndex: createTestPlanSelectorIndex(testplan),\n      idIndex: createTestPlanIdIndex(testplan),\n    };\n  }\n};\n\nexport const getAllureFullName = (test: Mocha.Test) => getAllureData(test).fullName;\n\nexport const isIncludedInTestRun = (test: Mocha.Test) => getAllureData(test).isIncludedInTestRun;\n\nexport const getAllureMetaLabels = (test: Mocha.Test) => getAllureData(test).labels;\n\nexport const getAllureMetaLinks = (test: Mocha.Test) => getAllureData(test).links;\n\nexport const getAllureId = (data: AllureMochaTestData) => {\n  const values = data.labels.filter((l) => l.name === LabelName.ALLURE_ID).map((l) => l.value);\n  if (values.length) {\n    return values[0];\n  }\n};\n\nexport const getAllureDisplayName = (test: Mocha.Test) => getAllureData(test).displayName;\n\nexport const getTestScope = (test: Mocha.Test) => getAllureData(test).scope;\n\nexport const setTestScope = (test: Mocha.Test, scope: string) => {\n  getAllureData(test).scope = scope;\n};\n\nexport const getSuitesOfMochaTest = (test: Mocha.Test) => test.titlePath().slice(0, -1);\n\nexport const resolveParallelModeSetupFile = () =>\n  join(dirname(filename), `setupAllureMochaParallel${extname(filename)}`);\n\nexport const getTestCaseId = (test: Mocha.Test) => {\n  const testFilePath = test.file ? getPosixPath(getRelativePath(test.file)) : \"\";\n  const suiteTitles = test.titlePath().slice(0, -1);\n  return md5(JSON.stringify([testFilePath, ...suiteTitles, getAllureDisplayName(test)]));\n};\n\nexport const applyTestPlan = (ids: ReadonlySet<string>, selectors: ReadonlySet<string>, rootSuite: Mocha.Suite) => {\n  const suiteQueue = [];\n  for (let s: Mocha.Suite | undefined = rootSuite; s; s = suiteQueue.shift()) {\n    for (const test of s.tests) {\n      const allureData = getAllureData(test);\n      const allureId = getAllureId(allureData);\n      if (!selectors.has(allureData.fullName) && (!allureId || !ids.has(allureId))) {\n        allureData.isIncludedInTestRun = false;\n        test.pending = true;\n      }\n    }\n    suiteQueue.push(...s.suites);\n  }\n};\n\nconst hookTypeRegexp = /^\"(before|after) (all|each)\"/;\n\nexport const getHookType = (hook: Mocha.Hook): HookType => {\n  if (hook.title) {\n    const match = hookTypeRegexp.exec(hook.title);\n    if (match) {\n      return [match[1] as HookCategory, match[2] as HookScope];\n    }\n  }\n  return [];\n};\n"],"mappings":"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","ignoreList":[]}