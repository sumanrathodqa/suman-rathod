{"version":3,"file":"extraReporters.js","names":["Mocha","_interopRequireWildcard","require","_nodeModule","_nodePath","_interopRequireDefault","e","__esModule","default","_getRequireWildcardCache","WeakMap","r","t","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","ownKeys","keys","getOwnPropertySymbols","o","filter","enumerable","push","apply","_objectSpread","arguments","length","forEach","_defineProperty","getOwnPropertyDescriptors","defineProperties","_toPropertyKey","value","configurable","writable","_toPrimitive","Symbol","toPrimitive","TypeError","String","Number","localRequire","createRequire","pathToFileURL","__filename","toString","enableExtraReporters","runner","options","extraReportersConfig","extraReporterEntries","Array","from","generateCanonicalizedReporterEntries","loadedReporterEntries","loadReporters","instantiateReporters","exports","doneAll","reporters","failures","fn","doneCallbacks","collectDoneCallbacks","callbacksToWait","onReporterIsDone","done","isReporterArrayEntry","resolveReporterArrayEntry","map","resolveReporterEntry","reporterEntries","_ref","moduleOrCtor","loadReporterModule","entries","Reporter","reporterOptions","optionsForReporter","reporter","bind","maybeReporterModuleOrCtor","maybeReporterOptions","builtInReporters","builtInReporterCtor","reporterModulePath","getReporterModulePath","Error","concat","message","module","resolve","path","reporterEntry"],"sources":["../../src/extraReporters.ts"],"sourcesContent":["import * as Mocha from \"mocha\";\nimport { createRequire } from \"node:module\";\nimport path from \"node:path\";\nimport type { ReporterDoneFn, ReporterEntry, ReporterModuleOrCtor, ReporterOptions } from \"./types.js\";\n\ntype CanonicalReporterEntry = readonly [ReporterModuleOrCtor, ReporterOptions];\ntype ShortReporterEntry = readonly [ReporterModuleOrCtor];\ntype LoadedReporterEntry = readonly [Mocha.ReporterConstructor, ReporterOptions];\n\n// There is no global require in ESM, and we can't use dynamic import (which returns a promise) because it's called from the reporter's constructor; therefore, it must be synchronous.\nconst localRequire = typeof require === \"function\" ? require : createRequire(import.meta.url);\n\nexport const enableExtraReporters = (\n  runner: Mocha.Runner,\n  options: Mocha.MochaOptions,\n  extraReportersConfig: ReporterEntry | readonly ReporterEntry[],\n) => {\n  const extraReporterEntries = Array.from(generateCanonicalizedReporterEntries(extraReportersConfig));\n  const loadedReporterEntries = loadReporters(extraReporterEntries);\n  return instantiateReporters(runner, options, loadedReporterEntries);\n};\n\nexport const doneAll = (\n  reporters: readonly Mocha.reporters.Base[],\n  failures: number,\n  fn?: ((failures: number) => void) | undefined,\n) => {\n  const doneCallbacks = collectDoneCallbacks(reporters);\n  let callbacksToWait = doneCallbacks.length + 1;\n  const onReporterIsDone = () => {\n    if (--callbacksToWait === 0) {\n      fn?.(failures);\n    }\n  };\n\n  for (const done of doneCallbacks) {\n    done(failures, onReporterIsDone);\n  }\n\n  onReporterIsDone(); // handle the synchronous completion\n};\n\nconst generateCanonicalizedReporterEntries = function* (\n  reporters: ReporterEntry | readonly ReporterEntry[] | undefined,\n): Generator<CanonicalReporterEntry, void, undefined> {\n  if (reporters) {\n    if (!(reporters instanceof Array)) {\n      yield [reporters, {}];\n    } else {\n      if (isReporterArrayEntry(reporters)) {\n        yield resolveReporterArrayEntry(reporters);\n      } else {\n        yield* reporters.map((e) => {\n          return resolveReporterEntry(e);\n        });\n      }\n    }\n  }\n};\n\nconst loadReporters = (reporterEntries: readonly CanonicalReporterEntry[]): LoadedReporterEntry[] =>\n  reporterEntries.map(([moduleOrCtor, options]) => [loadReporterModule(moduleOrCtor), options]);\n\nconst instantiateReporters = (\n  runner: Mocha.Runner,\n  options: Mocha.MochaOptions,\n  entries: readonly LoadedReporterEntry[],\n) => {\n  const reporters: Mocha.reporters.Base[] = [];\n  for (const [Reporter, reporterOptions] of entries) {\n    const optionsForReporter = {\n      ...options,\n      reporterOptions,\n      // eslint-disable-next-line quote-props\n      \"reporterOption\": reporterOptions,\n      \"reporter-option\": reporterOptions,\n    };\n    reporters.push(new Reporter(runner, optionsForReporter));\n  }\n  return reporters;\n};\n\nconst collectDoneCallbacks = (reporters: readonly Mocha.reporters.Base[]) => {\n  const doneCallbacks: ReporterDoneFn[] = [];\n  for (const reporter of reporters) {\n    if (reporter.done) {\n      doneCallbacks.push(reporter.done.bind(reporter));\n    }\n  }\n  return doneCallbacks;\n};\n\nconst isReporterArrayEntry = (\n  reporters: ShortReporterEntry | CanonicalReporterEntry | readonly ReporterEntry[],\n): reporters is ShortReporterEntry | CanonicalReporterEntry => {\n  const [maybeReporterModuleOrCtor, maybeReporterOptions = {}] = reporters;\n  return (\n    !(maybeReporterModuleOrCtor instanceof Array) &&\n    typeof maybeReporterOptions === \"object\" &&\n    !(maybeReporterOptions instanceof Array)\n  );\n};\n\nconst loadReporterModule = (moduleOrCtor: ReporterModuleOrCtor) => {\n  if (typeof moduleOrCtor === \"string\") {\n    const builtInReporters = Mocha.reporters as Record<string, Mocha.ReporterConstructor>;\n    const builtInReporterCtor = builtInReporters[moduleOrCtor];\n    if (builtInReporterCtor) {\n      return builtInReporterCtor;\n    }\n\n    const reporterModulePath = getReporterModulePath(moduleOrCtor);\n    try {\n      return localRequire(reporterModulePath) as Mocha.ReporterConstructor;\n    } catch (e: any) {\n      throw new Error(`Can't load the '${moduleOrCtor}' reporter from ${reporterModulePath}: ${e.message}`);\n    }\n  }\n\n  if (typeof moduleOrCtor !== \"function\") {\n    throw new Error(`A reporter value must be a string or a constructor. Got ${typeof moduleOrCtor}`);\n  }\n\n  return moduleOrCtor;\n};\n\nconst getReporterModulePath = (module: string) => {\n  try {\n    return localRequire.resolve(module);\n  } catch (e) {}\n\n  try {\n    return path.resolve(module);\n  } catch (e: any) {\n    throw new Error(`Can't resolve the '${module}' reporter's path: ${e.message}`);\n  }\n};\n\nconst resolveReporterEntry = (reporterEntry: ReporterEntry): CanonicalReporterEntry => {\n  return reporterEntry instanceof Array ? resolveReporterArrayEntry(reporterEntry) : [reporterEntry, {}];\n};\n\nconst resolveReporterArrayEntry = (\n  reporterEntry: ShortReporterEntry | CanonicalReporterEntry,\n): CanonicalReporterEntry => {\n  if (reporterEntry.length < 1 || reporterEntry.length > 2) {\n    throw new Error(\n      `If an extra reporter entry is an array, it must contain one or two elements. ${reporterEntry.length} found`,\n    );\n  }\n\n  return reporterEntry.length === 1 ? [...reporterEntry, {}] : [...reporterEntry];\n};\n"],"mappings":"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","ignoreList":[]}